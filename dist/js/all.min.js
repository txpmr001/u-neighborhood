function NeighborhoodVM(){var n=this;n.setFilter=function(e){n.filter(e)},n.selectPlace=function(e){e.isSelected(!0)},n.unselectAllPlaces=function(){mapPlaces().forEach(function(e){e.isSelected(!1)})},n.clickPlace=function(e){e.isSelected()?(n.unselectAllPlaces(),selectMarker(null)):(n.unselectAllPlaces(),n.selectPlace(e),selectMarker(markers[e.idx]))},n.loadPlaces=function(){$.getJSON("places.json").done(function(e,o,t){e.forEach(function(e){e.phone?e.phoneLink="tel:"+e.phone:e.phoneLink="",e.search=e.name.toUpperCase(),e.address&&(e.search=e.search+" "+e.address.toUpperCase()),e.isSelected=ko.observable(!1),mapPlaces().push(e)}),n.filter("")}).fail(function(e,o,t){alert("Error loading places data file. ("+t+") Details in the console.")})},n.initialize=function(){mapPlaces=ko.observable([]),n.filter=ko.observable(null),(mapFilteredPlaces=ko.computed(function(){var o=n.filter();return o?(o=o.toUpperCase(),mapPlaces().filter(function(e){return 0<=e.search.indexOf(o)})):mapPlaces()})).subscribe(function(e){filterMarkers()}),n.showMarkers=ko.observable("Yes"),n.showMarkers.subscribe(function(e){"Yes"==e?showMarkers():hideMarkers()})},n.initialize(),n.loadPlaces()}var map,lgInfoWindow,neighborhoodVM=new NeighborhoodVM;ko.applyBindings(neighborhoodVM);var initCenter,initZoom,mapPlaces,mapFilteredPlaces,markers=[];function sizeMap(){var e=$.mobile.getScreenHeight()-$(".toolbar").outerHeight();$(".map-content").height(e),$(".ui-panel-inner").height(e),$(".ui-panel").height(e)}function showMarkers(){markers.forEach(function(e){e.setMap(map)}),filterMarkers()}function hideMarkers(){markers.forEach(function(e){e.setMap(null)})}function getInfoApi(n,a,e){e="proxy.php?apiurl="+e,$.get(e).done(function(e,o,t){formatInfo(n,a,e,null,o)}).fail(function(e,o,t){formatInfo(n,a,null,e,o)})}function getInfo(e){if(e.googleDisplay=null,e.yelpDisplay=null,e.foursquareDisplay=null,e.googleId){getInfoApi(e,"google","https://maps.googleapis.com/maps/api/place/details/json?placeid="+e.googleId+"&key=%google_api_key%")}else{var o="<br><div>"+"No Google Id for this place"+"</div><br>";e.googleDisplay=o}if(e.yelpId){getInfoApi(e,"yelp","https://api.yelp.com/v3/businesses/"+e.yelpId+"&header=Authorization:%yelp_api_key%")}else{o="<br><div>"+"No Yelp Id for this place"+"</div><br>";e.yelpDisplay=o}var t=mapPlaces()[e.idx].location.lat,n=mapPlaces()[e.idx].location.lng;getInfoApi(e,"foursquare","https://api.foursquare.com/v2/venues/search?ll="+(t.toFixed(7)+","+n.toFixed(7))+"&v=20180101&client_id=%foursq_client_id%&client_secret=%foursq_client_secret%")}function showInfo(e){e.showInfo=e.showInfo+e.googleDisplay,e.showInfo=e.showInfo+e.yelpDisplay,e.showInfo=e.showInfo+e.foursquareDisplay,lgInfoWindow.marker=e,lgInfoWindow.setContent(e.showInfo),lgInfoWindow.open(map,e)}function addMarker(e,o,t,n,a){var r=new google.maps.Marker({idx:e,title:o,position:t,googleId:n,yelpId:a,icon:"images/blue-dot.png",map:map,animation:null});r.googleInfo=null,r.yelpInfo=null,r.foursquareInfo=null,r.addListener("click",function(){neighborhoodVM.unselectAllPlaces(),neighborhoodVM.selectPlace(mapPlaces()[this.idx]),selectMarker(this)}),markers.push(r)}function addMarkers(){mapPlaces().forEach(function(e){addMarker(e.idx,e.name,e.location,e.googleId,e.yelpId)})}function filterMarkers(){var o=[];mapFilteredPlaces().forEach(function(e){o.push(e.idx)}),markers.forEach(function(e){o.includes(e.idx)?e.setMap(map):e.setMap(null)})}function selectMarker(e){lgInfoWindow.marker&&lgInfoWindow.marker.setIcon("images/blue-dot.png"),lgInfoWindow.close(),e&&(lgInfoWindow.setContent(""),e.setIcon("images/red-dot.png"),null!==e.getAnimation()?e.setAnimation(null):(e.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){e.setAnimation(null)},2e3)),e.showInfo='<div style="text-align: center;"><strong>'+e.title+"</strong></div>",getInfo(e))}function initMap(){(lgInfoWindow=new google.maps.InfoWindow({content:""})).addListener("closeclick",function(){neighborhoodVM.unselectAllPlaces(),lgInfoWindow.marker.setIcon("images/blue-dot.png"),lgInfoWindow.marker=null});initCenter={lat:29.53915,lng:-98.664258},initZoom=13,map=new google.maps.Map(document.getElementById("map"),{center:initCenter,zoom:initZoom,styles:[{featureType:"administrative",elementType:"labels.text.fill",stylers:[{color:"#255b6b"}]},{featureType:"landscape",elementType:"all",stylers:[{color:"#f2f2f2"}]},{featureType:"landscape",elementType:"geometry.fill",stylers:[{color:"#f1efe8"}]},{featureType:"poi",elementType:"all",stylers:[{visibility:"off"}]},{featureType:"poi.park",elementType:"geometry.fill",stylers:[{visibility:"on"},{color:"#c9dfa7"}]},{featureType:"road",elementType:"all",stylers:[{saturation:-100},{lightness:45}]},{featureType:"road",elementType:"geometry.fill",stylers:[{color:"#aea87a"}]},{featureType:"road.highway",elementType:"all",stylers:[{visibility:"simplified"}]},{featureType:"road.arterial",elementType:"labels.icon",stylers:[{visibility:"off"}]},{featureType:"transit",elementType:"all",stylers:[{visibility:"off"}]},{featureType:"water",elementType:"geometry.fill",stylers:[{color:"#88c0c4"}]}],mapTypeControl:!0,mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.DROPDOWN_MENU}}),addMarkers()}$(document).on("pagecontainertransition",function(e){sizeMap()}),$(window).on("resize",function(e){sizeMap()}),$(window).on("orientationchange",function(e){sizeMap()}),$("#map").bind("touchstart",function(e){$("#search-mini").blur()}),$("#list-panel").click(function(){google.maps.event.trigger(map,"resize")}),$("#recenter-map").click(function(){map.setCenter(initCenter),map.setZoom(initZoom),google.maps.event.trigger(map,"resize")});var googleTemplate='<br><table style="background-color: #f0f0f0;">  <tr>   <td>      <div style="padding: 3px;">        %streetAddress%        <span style="padding-left: 20px">%openClosed%</span>      </div>      <div style="padding: 3px;">Hours: %hoursToday%</div>      <div style="padding: 3px;">        %websiteLink%        <span style="padding-left: 20px">Call: </span>        %phoneLink%      </div>    </td>  </tr>  <tr>    <td colspan="2" align="center">      %googleLink%    </td>  </tr>  <tr>    <td colspan="2" align="center">      %mapLink%    </td>  </tr></table>',yelpTemplate='<br><table style="background-color: #f0f0f0;">  <tr>    <td style="vertical-align: middle;">      <div><img src="%starsImg%" alt="Rating Stars" style="padding: 5px;"></div>      <div>%numReviews%</div>    </td>    <td style="vertical-align: middle; padding-left: 15px;">      %detailsLink%    </td>  </tr>  <tr>    <td colspan="2" align="center">      %yelpLink%    </td>  </tr></table>',foursquareTemplate='<br><table style="background-color: #f0f0f0;">  <tr>    <td style="vertical-align: middle;">      <div style="padding: 5px;">%category%</div>      <div>%checkinsCount%, %tipCount%.</div>    </td>    <td style="vertical-align: middle; padding-left: 15px;">      %detailsLink%    </td>  </tr>  <tr>    <td colspan="2" align="center">      %foursquareLink%    </td>  </tr></table>';function formatError(e,o,t,n,a){return console.log("formatError:",o,"marker",e.idx,e.title),console.log("formatError: apiData =",t),console.log("formatError: apiError =",n),console.log("formatError: textStatus =",a),"<br><div>"+("Error getting "+o+" info for this place.<br>(Details in Console.)")+"</div><br>"}function formatGoogle(e,o,t,n,a){var r="No address.",l="No open now info.",i="No hours info.",s="<span>No website.</span>",p="<span>No phone info.</span>",f='<img src="images/google_logo.png" alt="Google Logo" height="20">',g="No map link.";if(_.has(e.googleInfo,"result.formatted_address")&&(r=(r=e.googleInfo.result.formatted_address).substr(0,r.indexOf(","))),_.has(e.googleInfo,"result.opening_hours.open_now")&&(l="<strong>"+(l=e.googleInfo.result.opening_hours.open_now?"OPEN":"CLOSED")+"</strong> now."),_.has(e.googleInfo,"result.opening_hours.weekday_text")){var c=((new Date).getDay()+6)%7;i=e.googleInfo.result.opening_hours.weekday_text[c]}if(_.has(e.googleInfo,"result.website")&&(s='<a href="'+e.googleInfo.result.website+'" target="_blank" style="text-decoration: none;">View Website</a>'),_.has(e.googleInfo,"result.formatted_phone_number")&&(p='<a href="tel:'+e.googleInfo.result.formatted_phone_number+'" style="text-decoration: none;">'+e.googleInfo.result.formatted_phone_number+"</a>"),_.has(e,"googleId")){var d="https://www.google.com/maps/search/?api=1&query=Google&query_place_id="+e.googleId;f='<a href="'+d+'" target="_blank"><img src="images/google_logo.png" alt="Google Logo" height="20"></a>',g='<a href="'+d+'" target="_blank">View in Google Maps</a>'}var u=googleTemplate;return u=(u=(u=(u=(u=(u=(u=u.replace("%streetAddress%",r)).replace("%openClosed%",l)).replace("%hoursToday%",i)).replace("%websiteLink%",s)).replace("%phoneLink%",p)).replace("%googleLink%",f)).replace("%mapLink%",g)}function formatYelp(e,o,t,n,a){if(_.has(e.yelpInfo,"error.code")&&_.has(e.yelpInfo,"error.description"))var r=formatError(e,o,t,n,a);else{var l="imagenotfound.gif",i="No reviews number.",s='<img src="images/yelp_logo.png" alt="Yelp Logo" height="30">',p="No details link.";if(_.has(e.yelpInfo,"rating")){var f=e.yelpInfo.rating.toFixed(1);l="images/yelp_stars/regular_"+f.substr(0,f.indexOf("."))+("5"==f.substr(f.indexOf(".")+1)?"_half":"")+".png"}if(_.has(e.yelpInfo,"review_count")&&(i="Based on <strong>"+e.yelpInfo.review_count.toString()+"</strong> reviews."),_.has(e.yelpInfo,"url")){s='<a href="'+e.yelpInfo.url+'" target="_blank"><img src="images/yelp_logo.png" alt="Yelp Logo" height="30"></a>',p='<a href="'+e.yelpInfo.url+'" target="_blank">More<br>Details...</a>'}r=(r=(r=(r=(r=yelpTemplate).replace("%starsImg%",l)).replace("%numReviews%",i)).replace("%yelpLink%",s)).replace("%detailsLink%",p)}return r}function formatFoursquare(e,o,t,n,a){if(_.has(e.foursquareInfo,"meta.errorType")&&_.has(e.foursquareInfo,"meta.errorDetail"))var r=formatError(e,o,t,n,a);else{var l="No Category info.",i="No checkins info",s="No tip info",p='<img src="images/foursquare_logo.png" alt="Foursquare Logo" height="30">',f="No details link.";if(_.has(e.foursquareInfo,"response.venues")){var g=e.foursquareInfo.response.venues[0];if(_.has(g,"categories")&&(l=g.categories[0].name),_.has(g,"stats.checkinsCount")&&(i="<strong>"+g.stats.checkinsCount+"</strong> checkins"),_.has(g,"stats.tipCount")&&(s="<strong>"+g.stats.tipCount+"</strong> tips"),_.has(g,"id")){var c="http://foursquare.com/v/"+g.id;p='<a href="'+c+'" target="_blank"><img src="images/foursquare_logo.png" alt="Foursquare Logo" height="30"></a>',f='<a href="'+c+'" target="_blank">More<br>Details...</a>'}}r=(r=(r=(r=(r=(r=foursquareTemplate).replace("%category%",l)).replace("%checkinsCount%",i)).replace("%tipCount%",s)).replace("%foursquareLink%",p)).replace("%detailsLink%",f)}return r}function formatInfo(e,o,t,n,a){var r=o+"Info",l=o+"Display",i=!1;if(t)try{e[r]=JSON.parse(t)}catch(e){i=!0}else i=!0;i?formattedInfo=formatError(e,o,t,n,a):"google"==o?formattedInfo=formatGoogle(e,o,t,n,a):"yelp"==o?formattedInfo=formatYelp(e,o,t,n,a):"foursquare"==o&&(formattedInfo=formatFoursquare(e,o,t,n,a)),e[l]=formattedInfo,e.googleDisplay&&e.yelpDisplay&&e.foursquareDisplay&&showInfo(e)}